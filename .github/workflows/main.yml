name: "Build APK - Final Fix"
on:
  push:
    branches: [main, master]

jobs:
  build:
    runs-on: ubuntu-latest  # macOS ki jagah Ubuntu try karo

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: COMPLETE FIX
        run: |
          echo "=== STEP 1: Clean Everything ==="
          flutter clean
          rm -rf $HOME/.gradle/caches/
          rm -rf android/.gradle
          rm -rf android/build
          rm -rf build/
          
          echo "=== STEP 2: COMPLETELY REMOVE ICON FILES ==="
          # Purane icons DELETE
          rm -rf android/app/src/main/res/mipmap-*
          
          echo "=== STEP 3: Create NEW SIMPLE ICONS ==="
          # Create directories
          mkdir -p android/app/src/main/res/mipmap-mdpi
          mkdir -p android/app/src/main/res/mipmap-hdpi
          mkdir -p android/app/src/main/res/mipmap-xhdpi
          mkdir -p android/app/src/main/res/mipmap-xxhdpi
          mkdir -p android/app/src/main/res/mipmap-xxxhdpi
          
          # Create SIMPLE PNG FILES using ImageMagick
          sudo apt-get update
          sudo apt-get install -y imagemagick
          
          # Create a simple blue square (48x48)
          convert -size 48x48 xc:#2196F3 -fill white -draw "circle 24,24 24,12" android/app/src/main/res/mipmap-mdpi/ic_launcher.png
          convert -size 48x48 xc:#2196F3 -fill white -draw "circle 24,24 24,12" android/app/src/main/res/mipmap-mdpi/ic_launcher_round.png
          
          # 72x72
          convert -size 72x72 xc:#2196F3 -fill white -draw "circle 36,36 36,18" android/app/src/main/res/mipmap-hdpi/ic_launcher.png
          convert -size 72x72 xc:#2196F3 -fill white -draw "circle 36,36 36,18" android/app/src/main/res/mipmap-hdpi/ic_launcher_round.png
          
          # 96x96
          convert -size 96x96 xc:#2196F3 -fill white -draw "circle 48,48 48,24" android/app/src/main/res/mipmap-xhdpi/ic_launcher.png
          convert -size 96x96 xc:#2196F3 -fill white -draw "circle 48,48 48,24" android/app/src/main/res/mipmap-xhdpi/ic_launcher_round.png
          
          # 144x144
          convert -size 144x144 xc:#2196F3 -fill white -draw "circle 72,72 72,36" android/app/src/main/res/mipmap-xxhdpi/ic_launcher.png
          convert -size 144x144 xc:#2196F3 -fill white -draw "circle 72,72 72,36" android/app/src/main/res/mipmap-xxhdpi/ic_launcher_round.png
          
          # 192x192
          convert -size 192x192 xc:#2196F3 -fill white -draw "circle 96,96 96,48" android/app/src/main/res/mipmap-xxxhdpi/ic_launcher.png
          convert -size 192x192 xc:#2196F3 -fill white -draw "circle 96,96 96,48" android/app/src/main/res/mipmap-xxxhdpi/ic_launcher_round.png
          
          echo "=== STEP 4: Check created icons ==="
          file android/app/src/main/res/mipmap-*/*.png
          ls -la android/app/src/main/res/mipmap-*/*.png
          
          echo "=== STEP 5: Get dependencies ==="
          flutter pub get

      - name: Build APK with DEBUG
        run: |
          echo "=== STEP 6: Building APK ==="
          # Build with verbose logging
          flutter build apk --release \
            --no-tree-shake-icons \
            --no-shrink-resources \
            --verbose 2>&1 | tail -100
          
          # Alternative command if above fails
          echo "=== If failed, trying alternative ==="
          cd android
          ./gradlew clean
          ./gradlew assembleRelease --stacktrace || true
          cd ..

      - name: Check if APK created
        run: |
          echo "=== Checking for APK ==="
          find build -name "*.apk" -type f 2>/dev/null || true
          ls -la build/app/outputs/ || true

      - name: Force Build if Still Failing
        if: failure()
        run: |
          echo "=== LAST RESORT: Minimal Build ==="
          # Remove AndroidManifest icon reference
          sed -i 's/android:icon="@mipmap\/ic_launcher"/android:icon="@android:drawable\/sym_def_app_icon"/g' android/app/src/main/AndroidManifest.xml
          
          # Build without any resources
          flutter build apk --release \
            --no-tree-shake-icons \
            --no-shrink-resources \
            --no-obfuscate

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: app-release
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: Create Release
        if: success()
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/app-release.apk"
          tag: release-v${{ github.run_number }}
          token: ${{ secrets.BUDGET_TOKEN }}